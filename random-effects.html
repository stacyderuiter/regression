<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GLMs and Friends - 13&nbsp; Random Effects</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./random-effects2.html" rel="next">
<link href="./ncv.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./random-effects.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Random Effects</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">GLMs and Friends</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lm1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Linear Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./IC-based-selection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Model Selection Using Information Criteria</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./likelihood.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Likelihood</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pdf-pmf.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">PDFs and PMFs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./count-data-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Regression for Count Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./model-averaging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Model Averaging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Interactions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./binary-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Binary Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./binary-regression2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Binary regression: Data with more than one trial per row</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./collinearity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Collinearity and Multicollinearity</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./zero-inflation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Zero-Inflation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ncv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Non-constant variance (and other unresolved problems)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random-effects.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Random Effects</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random-effects2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Random effects with glmmTMB and standardized residuals</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gee-motivation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">GEEs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./corr-struct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Correlation Structures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./anova-plus.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Other Model Selection Approaches</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gams.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">GAMs: Generalized Additive Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#dataset" id="toc-dataset" class="nav-link active" data-scroll-target="#dataset"><span class="header-section-number">13.1</span> Dataset</a></li>
  <li><a href="#data-exploration" id="toc-data-exploration" class="nav-link" data-scroll-target="#data-exploration"><span class="header-section-number">13.2</span> Data Exploration</a></li>
  <li><a href="#a-base-linear-model" id="toc-a-base-linear-model" class="nav-link" data-scroll-target="#a-base-linear-model"><span class="header-section-number">13.3</span> A Base Linear Model</a>
  <ul class="collapse">
  <li><a href="#model-assessment" id="toc-model-assessment" class="nav-link" data-scroll-target="#model-assessment"><span class="header-section-number">13.3.1</span> Model assessment</a></li>
  </ul></li>
  <li><a href="#a-random-effects-model" id="toc-a-random-effects-model" class="nav-link" data-scroll-target="#a-random-effects-model"><span class="header-section-number">13.4</span> A Random Effects model</a>
  <ul class="collapse">
  <li><a href="#the-formula" id="toc-the-formula" class="nav-link" data-scroll-target="#the-formula"><span class="header-section-number">13.4.1</span> The Formula</a></li>
  <li><a href="#the-results" id="toc-the-results" class="nav-link" data-scroll-target="#the-results"><span class="header-section-number">13.4.2</span> The Results</a></li>
  <li><a href="#model-assessment-1" id="toc-model-assessment-1" class="nav-link" data-scroll-target="#model-assessment-1"><span class="header-section-number">13.4.3</span> Model Assessment</a></li>
  <li><a href="#refinement" id="toc-refinement" class="nav-link" data-scroll-target="#refinement"><span class="header-section-number">13.4.4</span> Refinement</a></li>
  </ul></li>
  <li><a href="#model-selection-for-mixed-models" id="toc-model-selection-for-mixed-models" class="nav-link" data-scroll-target="#model-selection-for-mixed-models"><span class="header-section-number">13.5</span> Model Selection for Mixed Models</a>
  <ul class="collapse">
  <li><a href="#reml-or-ml" id="toc-reml-or-ml" class="nav-link" data-scroll-target="#reml-or-ml"><span class="header-section-number">13.5.1</span> REML or ML?</a></li>
  <li><a href="#best-model-so-far" id="toc-best-model-so-far" class="nav-link" data-scroll-target="#best-model-so-far"><span class="header-section-number">13.5.2</span> Best model so far:</a></li>
  </ul></li>
  <li><a href="#random-slopes" id="toc-random-slopes" class="nav-link" data-scroll-target="#random-slopes"><span class="header-section-number">13.6</span> Random Slopes?</a></li>
  <li><a href="#prediction-plots" id="toc-prediction-plots" class="nav-link" data-scroll-target="#prediction-plots"><span class="header-section-number">13.7</span> Prediction Plots</a>
  <ul class="collapse">
  <li><a href="#parametric-bootstrap-to-the-rescue" id="toc-parametric-bootstrap-to-the-rescue" class="nav-link" data-scroll-target="#parametric-bootstrap-to-the-rescue"><span class="header-section-number">13.7.1</span> Parametric bootstrap to the rescue!</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Random Effects</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>We have seen a number of cases where model residuals were not independent, violation regression model conditions. What kind of model can address this kind of <em>dependent</em> data? Hierarchical models - here, models including <em>random effects</em> - are one way to approach this problem. These kinds of models go by many names, including hierarchical models, multi-level models, random effects models,or mixed effects models.</p>
<section id="dataset" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="dataset"><span class="header-section-number">13.1</span> Dataset</h2>
<p>From: Falcone et al.&nbsp;2017, <a href="http://rsos.royalsocietypublishing.org/content/royopensci/4/8/170629.full.pdf" class="uri">http://rsos.royalsocietypublishing.org/content/royopensci/4/8/170629.full.pdf</a></p>
<p>Satellite tags were used to record dive data and movements of 16 Cuvier’s beaked whales for up to 88 days each. The whales were incidentally exposed to different types of naval sonar exercises during the study period. How did characteristics of their dives change during sonar exposure? We will look specifically at shallow dive duration as a response variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">'http://sldr.netlify.com/data/zshal.csv'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>SonarA <span class="ot">&lt;-</span> <span class="fu">factor</span>(d<span class="sc">$</span>SonarA)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>SonarB <span class="ot">&lt;-</span> <span class="fu">factor</span>(d<span class="sc">$</span>SonarB)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-exploration" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="data-exploration"><span class="header-section-number">13.2</span> Data Exploration</h2>
<p>For these data, we are especially interested in how dive duration depends on sonar exposure. We also need to control for effects of other variables like depth and time of day.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_boxplot</span>(DurAvg <span class="sc">~</span> <span class="fu">factor</span>(SonarA), <span class="at">data=</span>d) <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Sonar A Presence'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_boxplot</span>(DurAvg <span class="sc">~</span> <span class="fu">factor</span>(SonarB), <span class="at">data=</span>d) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Sonar B Presence'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_boxplot</span>(DurAvg <span class="sc">~</span> TransClass, <span class="at">data=</span>d) <span class="sc">|&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Time of Day'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(DurAvg <span class="sc">~</span> DepthAvg, <span class="at">data=</span>d, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Max. Depth (m)'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(DurAvg <span class="sc">~</span> SonarAPercOL.fill, <span class="at">data=</span>d, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Percent Sonar A Overlap'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(DurAvg <span class="sc">~</span> SonarBPercOL.fill, <span class="at">data=</span>d, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gf_labs</span>(<span class="at">x=</span><span class="st">'Percent Sonar B Overlap'</span>, <span class="at">y=</span><span class="st">'Dive Duration (min.)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-3.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-4.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-5.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-3-6.png" class="img-fluid" width="336"></p>
</div>
</div>
</section>
<section id="a-base-linear-model" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="a-base-linear-model"><span class="header-section-number">13.3</span> A Base Linear Model</h2>
<p>A starting point for these data would be a basic linear regression, because the response variable is continuous, and we don’t have strong indication of nonlinear predictor-response relationships.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>base.model <span class="ot">&lt;-</span> <span class="fu">lm</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span>   SonarA <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                   SonarB <span class="sc">+</span>SonarAPercOL.fill <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                   SonarBPercOL.fill, <span class="at">data=</span>d)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(base.model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = DurAvg ~ DepthAvg + TransClass + SonarA + SonarB + 
    SonarAPercOL.fill + SonarBPercOL.fill, data = d)

Residuals:
    Min      1Q  Median      3Q     Max 
-34.344  -3.174  -0.148   2.891  40.732 

Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)       11.0774181  0.3056179  36.246  &lt; 2e-16 ***
DepthAvg           0.0384292  0.0005743  66.920  &lt; 2e-16 ***
TransClassDay     -0.8195877  0.2718055  -3.015  0.00258 ** 
TransClassDusk    -2.1080411  0.3536873  -5.960 2.66e-09 ***
TransClassNight   -2.4488002  0.2708857  -9.040  &lt; 2e-16 ***
SonarA1            2.6646627  1.8160219   1.467  0.14234    
SonarB1            5.1562595  0.8556973   6.026 1.78e-09 ***
SonarAPercOL.fill  0.7555749  2.1077356   0.358  0.72000    
SonarBPercOL.fill  0.8554161  2.2865382   0.374  0.70834    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 5.242 on 6174 degrees of freedom
Multiple R-squared:  0.4844,    Adjusted R-squared:  0.4837 
F-statistic: 725.1 on 8 and 6174 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<section id="model-assessment" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="model-assessment"><span class="header-section-number">13.3.1</span> Model assessment</h3>
<p>Let’s take a look right away at the model assessment plot that we suspect will be problematic for time-series data like ours. As we fear…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(base.model), <span class="at">main=</span><span class="st">'Residual ACF for base lm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="624"></p>
</div>
</div>
</section>
</section>
<section id="a-random-effects-model" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="a-random-effects-model"><span class="header-section-number">13.4</span> A Random Effects model</h2>
<p>This time we will try to account for the correlation over time within individuals using something called a <em>random effect</em> model (also known as a <em>mixed effects model</em>, <em>multilevel level</em>, among others). How does this model change our regression equation?</p>
<p>Recall that the form of a base linear model (with just 2 predictors) would be:</p>
<p><span class="math display">\[ y = \beta_0 + \beta_1x_1 + \beta_2x_2 + \epsilon\]</span></p>
<p>Where <span class="math inline">\(\epsilon \sim N(0,\sigma)\)</span> are the normally distributed residuals with mean 0.</p>
<p>Now… </p>
<section id="the-formula" class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="the-formula"><span class="header-section-number">13.4.1</span> The Formula</h3>
<p>The function to fit a linear random effect model is <code>lmer()</code>. For a Poisson or Logistic regression with random effects, it’s <code>glmer()</code>. Both are from the package <code>lme4</code>. We add random effects to the model formula with:</p>
<p><span class="math display">\[ + (1|variable)\]</span></p>
<p>or nested:</p>
<p><span class="math display">\[ + (1|variable1/variable2)\]</span></p>
<p>Let’s try a random effect of individual whale first. We have:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>rem1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  SonarA <span class="sc">+</span> SonarB <span class="sc">+</span>SonarAPercOL.fill<span class="sc">+</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    SonarBPercOL.fill <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>TagID), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some predictor variables are on very different scales: consider
rescaling</code></pre>
</div>
</div>
<p>Why yes - we <em>should</em> consider rescaling…what/why/how? </p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>SonarAPercScale <span class="ot">&lt;-</span> <span class="fu">scale</span>(d<span class="sc">$</span>SonarAPercOL.fill)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>SonarBPercScale <span class="ot">&lt;-</span> <span class="fu">scale</span>(d<span class="sc">$</span>SonarBPercOL.fill)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>rem2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  SonarA <span class="sc">+</span> SonarB <span class="sc">+</span> SonarAPercScale <span class="sc">+</span> </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    SonarBPercScale <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>TagID), </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-results" class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="the-results"><span class="header-section-number">13.4.2</span> The Results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(rem2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: DurAvg ~ DepthAvg + TransClass + SonarA + SonarB + SonarAPercScale +  
    SonarBPercScale + (1 | TagID)
   Data: d

REML criterion at convergence: 36982.5

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-7.1028 -0.5632 -0.0081  0.5297  7.8183 

Random effects:
 Groups   Name        Variance Std.Dev.
 TagID    (Intercept)  3.401   1.844   
 Residual             22.928   4.788   
Number of obs: 6183, groups:  TagID, 15

Fixed effects:
                  Estimate Std. Error t value
(Intercept)     11.0158506  0.5547014  19.859
DepthAvg         0.0391448  0.0005327  73.490
TransClassDay   -0.6416909  0.2490852  -2.576
TransClassDusk  -1.9171752  0.3235698  -5.925
TransClassNight -2.3456311  0.2479312  -9.461
SonarA1          3.4520183  1.6608961   2.078
SonarB1          4.5271312  0.7842742   5.772
SonarAPercScale  0.0362979  0.1716890   0.211
SonarBPercScale  0.1119528  0.0991365   1.129

Correlation of Fixed Effects:
            (Intr) DpthAv TrnsClssDy TrnsClssDs TrnsCN SonrA1 SonrB1 SnrAPS
DepthAvg    -0.282                                                         
TransClssDy -0.365 -0.055                                                  
TrnsClssDsk -0.308  0.051  0.650                                           
TrnsClssNgh -0.410  0.097  0.844      0.658                                
SonarA1     -0.029 -0.011 -0.011      0.004     -0.001                     
SonarB1     -0.006 -0.026 -0.037     -0.026     -0.006 -0.032              
SonrAPrcScl  0.029  0.009  0.001      0.001      0.001 -0.933 -0.002       
SonrBPrcScl  0.017  0.005 -0.005      0.011      0.003  0.020 -0.785  0.000</code></pre>
</div>
</div>
<p>How does this model compare to the original linear regression model? (Coefficient estimates? SEs? Additional stuff in the summary output?)</p>
</section>
<section id="model-assessment-1" class="level3" data-number="13.4.3">
<h3 data-number="13.4.3" class="anchored" data-anchor-id="model-assessment-1"><span class="header-section-number">13.4.3</span> Model Assessment</h3>
<p>How have the model assessment plots changed? Here we’ll focus mainly on the problem ACF.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gf_point</span>(<span class="fu">resid</span>(rem2)<span class="sc">~</span><span class="fu">fitted</span>(rem2), <span class="at">alpha=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="624"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(rem2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="624"></p>
</div>
</div>
</section>
<section id="refinement" class="level3" data-number="13.4.4">
<h3 data-number="13.4.4" class="anchored" data-anchor-id="refinement"><span class="header-section-number">13.4.4</span> Refinement</h3>
<p>What can we try next? </p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(d, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  TagID DurAvg           StartTime DepthAvg TransClass SonarA SonarB
1    14  17.58 2011-01-06 20:45:30    335.5        Day      0      0
2    14  19.71 2011-01-06 22:13:23    351.5        Day      0      0
3    14  18.11 2011-01-06 22:34:48    287.5        Day      0      0
  SonarAMinKm.fill SonarBMinKm.fill SonarAPercOL.fill SonarBPercOL.fill
1              500              500                 0                 0
2              500              500                 0                 0
3              500              500                 0                 0
      TagDay  Period       TagDayPeriod SonarAPercScale SonarBPercScale
1 2011-01-06 (18,20] 2011-01-06.(18,20]     -0.09784411      -0.1020368
2 2011-01-06 (20,22] 2011-01-06.(20,22]     -0.09784411      -0.1020368
3 2011-01-06 (20,22] 2011-01-06.(20,22]     -0.09784411      -0.1020368</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rem3 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span> SonarA <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>               SonarB <span class="sc">+</span>SonarAPercScale <span class="sc">+</span> SonarBPercScale <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">|</span>TagID<span class="sc">/</span>TagDayPeriod), <span class="at">data=</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(<span class="fu">resid</span>(rem3))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="624"></p>
</div>
</div>
</section>
</section>
<section id="model-selection-for-mixed-models" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="model-selection-for-mixed-models"><span class="header-section-number">13.5</span> Model Selection for Mixed Models</h2>
<p>Can we use our standard likelihood-based model selection criteria with random effects models?</p>
<p>Well…yes, and no.</p>
<section id="reml-or-ml" class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="reml-or-ml"><span class="header-section-number">13.5.1</span> REML or ML?</h3>
<p>There are two different ways to fit these models to data:</p>
<ul>
<li>by maximizing the likelihood (ML, as we learned about earlier in the course). Unfortunately, it turns out that in this case, the ML estimates of the variance components (the random effects) is biased, toward underestimating variance, when sample size is small.</li>
<li>by maximizing the restricted maximum likelihood (REML), which separates the likelhood into two parts (one with the fixed effects and one with the variance components). Maximizing parameters with respect to the second part only yields the REML estimators, which are unbiased and so preferred for smaller sample sizes. BUT there’s a catch…REML values can be used to compare models with different error and random effects structures, but <em>not</em> to determine which predictor variables should remain in a best model.</li>
</ul>
<p>Here, we do have a large sample size, so if we ensure our model is fitted by ML we can try using AIC or BIC for model selection. The default of <code>lmer()</code> and <code>glmer()</code> is to use REML, so if we want ML we have to add the input REML=FALSE to our call.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>rem4 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span> SonarA <span class="sc">+</span> SonarB <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>               SonarAPercScale <span class="sc">+</span>  SonarBPercScale <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">|</span>TagID<span class="sc">/</span>TagDayPeriod), <span class="at">data=</span>d,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">na.action=</span><span class="st">'na.fail'</span>, <span class="at">REML=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00309987 (tol = 0.002, component 1)</code></pre>
</div>
</div>
<p>In doing model selection for random effects models, <code>dredge()</code> knows to keep the random effects terms present in all models, so we don’t have to specify them as <em>fixed</em> terms.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MuMIn)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>rem4_sel <span class="ot">&lt;-</span> <span class="fu">dredge</span>(rem4, <span class="at">rank=</span><span class="st">'BIC'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Fixed term is "(Intercept)"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00309987 (tol = 0.002, component 1)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(rem4_sel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Global model call: lmer(formula = DurAvg ~ DepthAvg + TransClass + SonarA + SonarB + 
    SonarAPercScale + SonarBPercScale + (1 | TagID/TagDayPeriod), 
    data = d, REML = FALSE, na.action = "na.fail")
---
Model selection table 
   (Intrc)   DpthA SonrA  SnAPS SonrB   SnBPS TrnsC df    logLik     BIC delta
44   10.66 0.03985     +            +             + 10 -18081.06 36249.4  0.00
46   10.69 0.03986       0.2679     +             + 10 -18081.52 36250.3  0.92
42   10.68 0.03987                  +             +  9 -18088.50 36255.6  6.15
48   10.67 0.03985     + 0.1051     +             + 11 -18080.83 36257.7  8.28
60   10.66 0.03985     +            + 0.02154     + 11 -18081.03 36258.1  8.67
62   10.69 0.03986       0.2688     + 0.02007     + 11 -18081.50 36259.0  9.60
   weight
44  0.583
46  0.368
42  0.027
48  0.009
60  0.008
62  0.005
Models ranked by BIC(x) 
Random terms (all models): 
  1 | TagID/TagDayPeriod</code></pre>
</div>
</div>
</section>
<section id="best-model-so-far" class="level3" data-number="13.5.2">
<h3 data-number="13.5.2" class="anchored" data-anchor-id="best-model-so-far"><span class="header-section-number">13.5.2</span> Best model so far:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>rem5 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(DurAvg <span class="sc">~</span> DepthAvg <span class="sc">+</span> TransClass <span class="sc">+</span> SonarA <span class="sc">+</span> SonarB <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>               (<span class="dv">1</span><span class="sc">|</span>TagID<span class="sc">/</span>TagDayPeriod), <span class="at">data=</span>d,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">na.action=</span><span class="st">'na.fail'</span>, <span class="at">REML=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="random-slopes" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="random-slopes"><span class="header-section-number">13.6</span> Random Slopes?</h2>
<p>What we just practiced and called a “random effect” is sometimes also called a “random intercept” model because, although we allowed for an offset between the overall average predicted response value and that of an individual, we did not allow the <em>slope</em> of the relationship with any of the predictor variables to vary randomly with individual. It is possible to do this, although in my experience it often makes interpretation difficult.</p>
<p>Before you do it, think to yourself: do you really think that there is random variation in the relationship of the predictor with the response? One case where random slopes will work well is where there is a strong, clear overall effect and small variations in its magnitude between individuals. Another might be where the relationship with a certain predictor has very strong and very different slopes for different individuals, and you want to account for the added variability this adds to the model.</p>
<p>In the <code>(g)lmer()</code> formula, a model with a random slope <em>and</em> intercept in relation to a particular predictor is specified with the form:</p>
<p><span class="math display">\[ ... + (PredictorVariable | GroupingVariable)\]</span> or equivalently <span class="math display">\[ ... + (1 + PredictorVariable | GroupingVariable)\]</span></p>
<p>If you want to have a random slope for a certain predictor <em>without</em> the corresponding random intercept ( I can’t think of an example where this would be a good idea but you can do it), then use:</p>
<p><span class="math display">\[ ... + (0 + PredictorVariable | GroupingVariable)\]</span></p>
</section>
<section id="prediction-plots" class="level2" data-number="13.7">
<h2 data-number="13.7" class="anchored" data-anchor-id="prediction-plots"><span class="header-section-number">13.7</span> Prediction Plots</h2>
<p>There is a bit of added work involved in making prediction plots for some random effects models.</p>
<p>Unlike GEEs, which provide <em>marginal</em> predictions (predictions of the population average value for any combination of predictor variable values), random effects models provide predictions for an <em>average individual</em>. <strong>For a linear regression model (or any model with the identity link function, that is, no link function), the predicted values for the population average and average individual are the same</strong>. But with a link function in the mix, <strong>it’s different</strong>. Consider a (hypothetical) example of a logistic regression modelling probability of passing a test as a function of hours of instruction spent before the test.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="random-effects_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="336"></p>
</div>
<div class="cell-output-display">
<p><img src="images/LogRegIndAve.png" class="img-fluid"></p>
</div>
</div>
<section id="parametric-bootstrap-to-the-rescue" class="level3" data-number="13.7.1">
<h3 data-number="13.7.1" class="anchored" data-anchor-id="parametric-bootstrap-to-the-rescue"><span class="header-section-number">13.7.1</span> Parametric bootstrap to the rescue!</h3>
<p>How can we get around this problem? We can make predictions from our model for many, many (simulated) individuals to get a ``population” of predictions. Then, we can take a point-wise average over all those individuals (and also use them to find a CI), to get population average predictions and confidence intervals.</p>
<p>We can do this with help from the function <code>bootMer()</code> from the <code>lme4</code> package.</p>
<p>To make this work, we first need a <strong>function</strong> that makes <strong>predictions from our model</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function to make predictions from a fitted model</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(s245)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># predict_rem4 &lt;- function(model){</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   orig_dat &lt;- model@frame</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   fixed_vals &lt;- get_fixed(orig_dat[,c(2:ncol(orig_dat))])</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   new_dat &lt;- get_new_data(orig_dat, predictor='SonarA', fixed_vals)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(predict(model, newdata = new_dat, </span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">#                  type = "response", allow.new.levels=TRUE))</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>bootMer()</code> does parametric bootstrap simulations and each time, computes some function of the fitted model (here, predictions.) We can then examine the quantiles of these bootstrap predictions (the median or mean is our <em>estimate</em> or best-guess predicted value, and the <em>2.5 and 97.5 percentiles</em> are the <em>bounds of a 95 percent CI</em>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># boot_rem4 &lt;- bootMer(rem4, FUN = predict_rem4, nsim = 1000, </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                      type = "parametric", use.u = FALSE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># glimpse(boot_rem4$t )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># orig_dat &lt;- rem4@frame</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed_vals &lt;- get_fixed(orig_dat[,c(2:ncol(orig_dat))])</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># new_dat &lt;- get_new_data(orig_dat, predictor='SonarA',</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                           fixed_vals)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># new_dat &lt;- new_dat |&gt;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(pred = apply(boot_rem4$t, 2, mean),</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">#          CIlow = apply(boot_rem4$t, 2, quantile, probs=0.025),</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#          CIhigh = apply(boot_rem4$t, 2, quantile, probs=0.975)</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#          )</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># gf_point(pred ~ SonarA, data=new_dat) |&gt;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   gf_labs(x='Sonar A Presence', y='Dive Duration (min.)') |&gt;</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   gf_errorbar(CIlow + CIhigh ~ SonarA, data=new_dat, width=0.3)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(Because…)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred_plot(rem4, 'SonarA')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./ncv.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Non-constant variance (and other unresolved problems)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./random-effects2.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Random effects with glmmTMB and standardized residuals</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>